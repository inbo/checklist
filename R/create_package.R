#' Create an R package according to INBO requirements
#' @param package Name of the new package.
#' @param path Where to create the package directory.
#' @param title A single sentence with the title of the package.
#' @param description A single paragraph describing the package.
#' @param maintainer The output of `orcid2person()`.
#' @export
#' @importFrom assertthat assert_that is.string
#' @importFrom git2r add  init
#' @importFrom tools toTitleCase
#' @importFrom utils sessionInfo
create_package <- function(
  package, path = ".", title, description, maintainer
) {
  assert_that(
    length(find.package("roxygen2", quiet = TRUE)) > 0,
    msg =
      "Please install the `roxygen2` package. `install.packages(\"roxygen2\")`"
  )
  assert_that(inherits(maintainer, "person"))
  assert_that(dir.exists(path), msg = sprintf("`%s` is not a directory", path))
  assert_that(is.string(package))
  assert_that(valid_package_name(package))
  path <- file.path(path, package)
  assert_that(
    length(list.files(path, recursive = TRUE)) == 0,
    msg = sprintf("`%s` is not an empty directory", path)
  )
  assert_that(is.string(title))

  dir.create(path, showWarnings = FALSE)
  repo <- init(path)
  dir.create(file.path(path, "R"))

  # create DESCRIPTION
  description <- sprintf(
"Type: Package
Package: %s
Title: %s
Version: 0.0.0
Authors@R:
  c(%s,
    person(given = \"Research Institute for Nature and Forest\",
           role = c(\"cph\", \"fnd\"),
           email = \"info@inbo.be\"))
Description: %s
License: GPL-3
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: %s
",
    package, toTitleCase(title),
    paste(format(maintainer, style = "R"), collapse = "\n"),
    description,
    sessionInfo("roxygen2")$otherPkgs$roxygen2$Version
  )
  writeLines(description, file.path(path, "DESCRIPTION"))
  description <- desc::description$new(file = file.path(path, "DESCRIPTION"))
  tidy_desc(description)
  description$write(file.path(path, "DESCRIPTION"))
  add(repo = repo, "DESCRIPTION")

  # create NAMESPACE
  writeLines(
    c("# Generated by roxygen2: do not edit by hand", ""),
    file.path(path, "NAMESPACE")
  )
  add(repo = repo, "NAMESPACE")

  # create RStudio project
  file.copy(
    system.file("package_template/rproj", package = "checklist"),
    file.path(path, paste0(package, ".Rproj"))
  )
  add(repo = repo, paste0(package, ".Rproj"))

  # add .gitignore
  file.copy(
    system.file("package_template/.gitignore", package = "checklist"),
    file.path(path, ".gitignore")
  )
  add(repo = repo, ".gitignore")

  # add .Rbuildignore
  file.copy(
    system.file("package_template/rbuildignore", package = "checklist"),
    file.path(path, ".Rbuildignore")
  )
  add(repo = repo, ".Rbuildignore")

  # add codecov.yml
  file.copy(
    system.file("package_template/codecov.yml", package = "checklist"),
    file.path(path, "codecov.yml")
  )
  add(repo = repo, "codecov.yml")

  # add NEWS.md
  news <- sprintf(
    "# %s 0.0.0\n\n* Added a `NEWS.md` file to track changes to the package.",
    package
  )
  writeLines(news, file.path(path, "NEWS.md"))
  add(repo = repo, "NEWS.md")

  # add README.Rmd
  readme <- readLines(
    system.file("package_template/README.Rmd", package = "checklist")
  )
  readme <- gsub("\\{\\{\\{ Package \\}\\}\\}", package, readme)
  writeLines(readme, file.path(path, "README.Rmd"))
  add(repo = repo, "README.Rmd")

  # add checklist.yml
  writeLines(
  "description: Configuration file for checklist::check_pkg()
package: yes
allowed:
  warnings: []
  notes: []",
    file.path(path, "checklist.yml")
  )
  add(repo = repo, "checklist.yml")

  message("package created at `", path, "`")
  return(invisible(NULL))
}

valid_package_name <- function(x) {
  grepl("^[a-zA-Z][a-zA-Z0-9.]+$", x) && !grepl("\\.$", x)
}

#' @importFrom assertthat `on_failure<-`
on_failure(valid_package_name) <- function(call, env) {
  paste(deparse(call$x), "is not a valid package name.")
}
