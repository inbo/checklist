#' Create an R package according to INBO requirements
#'
#' Creates a package template in a new folder.
#' Use this function when you want to start a new package.
#'
#' What you get:
#'
#' - minimal folder structure and files required for an R package using INBO
#'   guidelines with GPL-3 license.
#' - an RStudio project file
#' - a local git repository
#' - an initial `NEWS.md` file
#' - a template for an `README.Rmd`
#' - set-up for automate checks and releases of the package using GitHub
#'   Actions.
#' - a code of conduct and contributing guidelines.
#' - the set-up for a `pkgdown` website using the INBO corporate identity.
#'
#' What you still have to do:
#'
#' - create a new repository on https://github.com/inbo.
#' - Set the ORCID_TOKEN and CODEDOC_TOKEN as repository secrets.
#' - set this repository as the remote origin of the local git repository.
#' - configure the build tools in RStudio to render Roxygen documentation.
#'   whenever you install or restart the package.
#' - add some functions to the package.
#' - commit changes and push them to GitHub.
#' @param package Name of the new package.
#' @param path Where to create the package directory.
#' @param title A single sentence with the title of the package.
#' @param description A single paragraph describing the package.
#' @param maintainer The output of [utils::person()] or `orcid2person()`.
#'   If you use [utils::person()], then you must provide `given`, `family`,
#'   `role`, `email` and  `comment` with valid `ORCID`.
#' @export
#' @importFrom assertthat assert_that is.string
#' @importFrom git2r add  init
#' @importFrom tools toTitleCase
#' @importFrom utils sessionInfo
#' @family setup
create_package <- function(
  package, path = ".", title, description, maintainer
) {
  assert_that(
    length(find.package("roxygen2", quiet = TRUE)) > 0,
    msg =
      "Please install the `roxygen2` package. `install.packages(\"roxygen2\")`"
  )
  assert_that(inherits(maintainer, "person"))
  assert_that(dir.exists(path), msg = sprintf("`%s` is not a directory", path))
  assert_that(is.string(package))
  assert_that(valid_package_name(package))
  path <- file.path(path, package)
  assert_that(
    length(list.files(path, recursive = TRUE)) == 0,
    msg = sprintf("`%s` is not an empty directory", path)
  )
  assert_that(is.string(title))

  dir.create(path, showWarnings = FALSE)
  repo <- init(path)
  dir.create(file.path(path, "R"))

  # create DESCRIPTION
  description <- sprintf(
"Type: Package
Package: %s
Title: %s
Version: 0.0.0
Authors@R:
  c(%s,
    person(given = \"Research Institute for Nature and Forest\",
           role = c(\"cph\", \"fnd\"),
           email = \"info@inbo.be\"))
Description: %s
License: GPL-3
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: %s
",
    package, toTitleCase(title),
    paste(format(maintainer, style = "R"), collapse = "\n"),
    description,
    sessionInfo("roxygen2")$otherPkgs$roxygen2$Version
  )
  writeLines(description, file.path(path, "DESCRIPTION"))
  tidy_desc(path)
  add(repo = repo, "DESCRIPTION")

  # create NAMESPACE
  writeLines(
    c("# Generated by roxygen2: do not edit by hand", ""),
    file.path(path, "NAMESPACE")
  )
  add(repo = repo, "NAMESPACE")

  # create RStudio project
  file.copy(
    system.file("package_template/rproj.template", package = "checklist"),
    file.path(path, paste0(package, ".Rproj"))
  )
  add(repo = repo, paste0(package, ".Rproj"))

  # add .gitignore
  file.copy(
    system.file("generic_template/.gitignore", package = "checklist"),
    file.path(path, ".gitignore")
  )
  add(repo = repo, ".gitignore")

  # add .Rbuildignore
  file.copy(
    system.file("package_template/rbuildignore", package = "checklist"),
    file.path(path, ".Rbuildignore")
  )
  add(repo = repo, ".Rbuildignore")

  # add codecov.yml
  file.copy(
    system.file("package_template/codecov.yml", package = "checklist"),
    file.path(path, "codecov.yml")
  )
  add(repo = repo, "codecov.yml")

  # add NEWS.md
  news <- sprintf(
    "# %s 0.0.0\n\n* Added a `NEWS.md` file to track changes to the package.",
    package
  )
  writeLines(news, file.path(path, "NEWS.md"))
  add(repo = repo, "NEWS.md")

  # add README.Rmd
  readme <- readLines(
    system.file("package_template/README.Rmd", package = "checklist")
  )
  readme <- gsub("\\{\\{\\{ Package \\}\\}\\}", package, readme)
  writeLines(readme, file.path(path, "README.Rmd"))
  add(repo = repo, "README.Rmd")

  # add LICENSE.md
  file.copy(
    system.file("generic_template/gplv3.md", package = "checklist"),
    file.path(path, "LICENSE.md")
  )
  add(repo = repo, "LICENSE.md")

  # add checklist.yml
  writeLines(
  "description: Configuration file for checklist::check_pkg()
package: yes
allowed:
  warnings: []
  notes: []",
    file.path(path, "checklist.yml")
  )
  add(repo = repo, "checklist.yml")

  # Add code of conduct
  dir.create(file.path(path, ".github"))
  file.copy(
    system.file("generic_template/CODE_OF_CONDUCT.md", package = "checklist"),
    file.path(path, ".github", "CODE_OF_CONDUCT.md")
  )
  add(repo = repo, ".github/CODE_OF_CONDUCT.md")

  # Add contributing guidelines
  file.copy(
    system.file("package_template/CONTRIBUTING.md", package = "checklist"),
    file.path(path, ".github", "CONTRIBUTING.md")
  )
  add(repo = repo, ".github/CONTRIBUTING.md")

  # Add GitHub actions
  dir.create(file.path(path, ".github", "workflows"), showWarnings = FALSE)
  file.copy(
    system.file("package_template/check_on_branch.yml", package = "checklist"),
    file.path(path, ".github", "workflows", "check_on_branch.yml"),
    overwrite = TRUE
  )
  add(repo = repo, ".github/workflows/check_on_branch.yml", force = TRUE)
  file.copy(
    system.file("package_template/check_on_master.yml", package = "checklist"),
    file.path(path, ".github", "workflows", "check_on_master.yml"),
    overwrite = TRUE
  )
  add(repo = repo, ".github/workflows/check_on_master.yml", force = TRUE)
  file.copy(
    system.file(
      "package_template/check_on_different_r_os.yml",
      package = "checklist"
    ),
    file.path(path, ".github", "workflows", "check_on_different_r_os.yml"),
    overwrite = TRUE
  )
  add(
    repo = repo,
    ".github/workflows/check_on_different_r_os.yml",
    force = TRUE
  )
  file.copy(
    system.file(
      "package_template/release.yml",
      package = "checklist"
    ),
    file.path(path, ".github", "workflows", "release.yml"),
    overwrite = TRUE
  )
  add(
    repo = repo,
    ".github/workflows/release.yml",
    force = TRUE
  )

  # prepare pkgdown
  file.copy(
    system.file("package_template/_pkgdown.yml", package = "checklist"),
    file.path(path, "_pkgdown.yml")
  )
  add(repo = repo, "_pkgdown.yml")

  dir.create(file.path(path, "pkgdown"), showWarnings = FALSE)
  file.copy(
    system.file("package_template/pkgdown.css", package = "checklist"),
    file.path(path, "pkgdown", "extra.css")
  )
  add(repo = repo, "pkgdown/extra.css")
  dir.create(
    file.path(path, "man", "figures"), showWarnings = FALSE, recursive = TRUE
  )
  file.copy(
    system.file("help/figures/logo-en.png", package = "checklist"),
    file.path(path, "man", "figures", "logo-en.png"), overwrite = TRUE
  )
  add(repo = repo, "man/figures/logo-en.png", force = TRUE)
  file.copy(
    system.file("help/figures/background-pattern.png", package = "checklist"),
    file.path(path, "man", "figures", "background-pattern.png"),
    overwrite = TRUE
  )
  add(repo = repo, "man/figures/background-pattern.png", force = TRUE)
  file.copy(
    system.file("package_template/flanders.woff2", package = "checklist"),
    file.path(path, "man", "figures", "flanders.woff2"), overwrite = TRUE
  )
  add(repo = repo, "man/figures/flanders.woff2", force = TRUE)
  file.copy(
    system.file("package_template/flanders.woff", package = "checklist"),
    file.path(path, "man", "figures", "flanders.woff"), overwrite = TRUE
  )
  add(repo = repo, "man/figures/flanders.woff", force = TRUE)

  message("package created at `", path, "`")
  return(invisible(NULL))
}

valid_package_name <- function(x) {
  grepl("^[a-zA-Z][a-zA-Z0-9.]+$", x) && !grepl("\\.$", x)
}

#' @importFrom assertthat `on_failure<-`
on_failure(valid_package_name) <- function(call, env) {
  paste(deparse(call$x), "is not a valid package name.")
}
