#' Create an R package according to INBO requirements
#'
#' Creates a package template in a new folder.
#' Use this function when you want to start a new package.
#' Please DO READ `vignette("getting_started")` before running this function.
#'
#' @template checklist_structure
#'
#' @param package Name of the new package.
#' @param path Where to create the package directory.
#' @export
#' @importFrom assertthat assert_that is.flag is.string noNA
#' @importFrom desc description
#' @importFrom fs dir_create dir_ls file_copy is_dir path
#' @importFrom gert git_add git_init
#' @importFrom tools toTitleCase
#' @importFrom utils installed.packages
#' @family setup
create_package <- function(package, path = ".") {
  assert_that(
    length(find.package("roxygen2", quiet = TRUE)) > 0,
    msg = paste(
      "Please install the `roxygen2` package.",
      "`install.packages(\"roxygen2\")`"
    )
  )
  # validate user input
  assert_that(is_dir(path), msg = sprintf("`%s` is not a directory", path))
  assert_that(is.string(package))
  assert_that(valid_package_name(package))
  path <- path(path, package)
  assert_that(
    !is_dir(path) || length(dir_ls(path, recurse = TRUE)) == 0,
    msg = sprintf("`%s` is not an empty directory", path)
  )

  # ask interactive information
  title <- readline(prompt = "Enter the title: ")
  description <- readline(prompt = "Enter the description: ")
  keywords <- ask_keywords()
  preferred_protocol() |>
    sprintf(package) -> git
  org <- org_list_from_url(git)
  license <- ask_license(org, type = "package")
  language <- ask_language(org)
  authors <- package_maintainer(org = org, lang = language)

  # start creating package
  dir_create(path)
  repo <- git_init(path = path)
  git_remote_add(url = git, name = "origin", repo = repo)
  dir_create(path(path, "R"))

  # add checklist.yml
  x <- checklist$new(x = path, package = TRUE, language = language)
  x$set_ignore(c(".github", "LICENSE.md"))
  write_checklist(x)
  git_add("checklist.yml", repo = repo)

  # create DESCRIPTION
  desc <- desc::description$new("!new")
  desc$set("Package", package)
  desc$set("Title", toTitleCase(title))
  desc$set_version("0.0.0")
  desc$set_authors(authors)
  desc$set("Description", description)
  desc$set("License", ifelse(license == "MIT", "MIT + file LICENSE", license))
  org_url <- gsub("\\.git$", "", git, perl = TRUE)
  if (!grepl("^https:\\/\\/", org_url)) {
    org_url <- gsub("^git@(.*):", "https://\\1/", org_url, perl = TRUE)
  }
  desc$set_urls(org_url)
  desc$set("BugReports", sprintf("%s/issues", org_url))

  desc <- append_communities(desc = desc, org = org)
  desc$set("Config/checklist/keywords", paste(keywords, collapse = "; "))
  desc$set("Encoding", "UTF-8")
  desc$set("Language", language)
  desc$set("Roxygen", "list(markdown = TRUE)")
  desc$set("RoxygenNote", installed.packages()["roxygen2", "Version"])
  desc$del("Maintainer")
  desc$write(path(path, "DESCRIPTION"))
  git_add("DESCRIPTION", repo = repo)

  # create NAMESPACE
  c("# Generated by roxygen2: do not edit by hand", "") |>
    writeLines(path(path, "NAMESPACE"))
  git_add("NAMESPACE", repo = repo)

  # create RStudio project
  insert_file(
    repo = repo,
    filename = "rproj.template",
    template = "package_template",
    target = path,
    new_name = paste0(package, ".Rproj")
  )

  # add .gitignore
  insert_file(
    repo = repo,
    filename = "gitignore",
    template = "generic_template",
    target = path,
    new_name = ".gitignore"
  )

  # add .Rbuildignore
  insert_file(
    repo = repo,
    filename = "rbuildignore",
    template = "package_template",
    target = path,
    new_name = ".Rbuildignore"
  )

  # add codecov.yml
  insert_file(
    repo = repo,
    filename = "codecov.yml",
    template = "package_template",
    target = path
  )

  # add NEWS.md
  paste(
    "# %s 0.0.0",
    "",
    "* Added a `NEWS.md` file to track changes to the package.",
    "* Add [`checklist`](https://inbo.github.io/checklist/) infrastructure.",
    sep = "\n"
  ) |>
    sprintf(package) |>
    writeLines(path(path, "NEWS.md"))
  git_add("NEWS.md", repo = repo)

  # add README.Rmd
  license_badge <- switch(
    license,
    "GPL-3" = "https://img.shields.io/badge/license-GPL--3-blue.svg?style=flat",
    "MIT" = "https://img.shields.io/badge/license-MIT-blue.svg?style=flat",
    ""
  )
  license_site <- switch(
    license,
    "GPL-3" = "https://spdx.org/licenses/GPL-3.0-only.html",
    "MIT" = "https://opensource.org/licenses/MIT",
    ""
  )
  path("package_template", "README.Rmd") |>
    system.file(package = "checklist") |>
    readLines() |>
    gsub(pattern = "\\{\\{\\{ Package \\}\\}\\}", replacement = package) -> rdme
  if (license_badge != "") {
    rdme |>
      gsub(
        pattern = "\\{\\{\\{ license badge \\}\\}\\}",
        replacement = license_badge
      ) |>
      gsub(
        pattern = "\\{\\{\\{ license site \\}\\}\\}",
        replacement = license_site
      ) -> rdme
  }
  rdme |>
    gsub(pattern = ".*\\{\\{\\{ license badge \\}\\}\\}.*", replacement = "") |>
    writeLines(path(path, "README.Rmd"))
  git_add("README.Rmd", repo = repo)

  # add LICENSE.md
  set_license(x, license = license, org = org)
  git_add("LICENSE.md", repo = repo)

  # Add code of conduct
  target <- path(path, ".github")
  dir_create(target)
  insert_file(
    repo = repo,
    filename = "CODE_OF_CONDUCT.md",
    template = "generic_template",
    target = target
  )

  # Add contributing guidelines
  insert_file(
    repo = repo,
    filename = "CONTRIBUTING.md",
    template = "generic_template",
    target = target
  )

  # Add GitHub actions
  target <- path(path, ".github", "workflows")
  dir_create(target)
  insert_file(
    repo = repo,
    filename = "check_on_branch.yml",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "check_on_main.yml",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "check_on_different_r_os.yml",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "release.yml",
    template = "package_template",
    target = target
  )

  # prepare pkgdown
  path("package_template", "_pkgdown.yml") |>
    system.file(package = "checklist") |>
    readLines() |>
    gsub(pattern = "\\{\\{\\{ Package \\}\\}\\}", replacement = package) |>
    writeLines(path(path, "_pkgdown.yml"))
  git_add("_pkgdown.yml", repo = repo)

  target <- path(path, "pkgdown")
  dir_create(target)
  insert_file(
    repo = repo,
    filename = "pkgdown.css",
    template = "package_template",
    target = target,
    new_name = "extra.css"
  )

  target <- path(path, "man", "figures")
  dir_create(target)
  insert_file(
    repo = repo,
    filename = "logo-en.png",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "background-pattern.png",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "flanders.woff2",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "flanders.woff",
    template = "package_template",
    target = target
  )

  message("package created at `", path, "`")

  if (
    !interactive() ||
      !requireNamespace("rstudioapi", quietly = TRUE) ||
      !rstudioapi::isAvailable()
  ) {
    return(invisible(NULL))
  }
  rstudioapi::openProject(path, newSession = TRUE)
}

valid_package_name <- function(x) {
  grepl("^[a-zA-Z][a-zA-Z0-9.]+$", x) && !grepl("\\.$", x)
}

package_maintainer <- function(org, lang) {
  message("Please select the maintainer")
  maintainer <- author2person(role = c("aut", "cre"), lang = lang)
  while (isTRUE(ask_yes_no("Add another author?", default = FALSE))) {
    maintainer <- c(maintainer, author2person(role = "aut", lang = lang))
  }
  available <- org$get_default_name
  funder <- character(0)
  while (
    length(available) > 0 &&
      isTRUE(ask_yes_no("Add a funder?", default = FALSE))
  ) {
    c("default funder", available) |>
      menu_first(title = "Select a funder:") -> selected
    if (selected > 1) {
      funder <- c(funder, names(available)[selected + 1])
    } else {
      funder <- org$get_default_funder
    }
  }
  if (length(funder) == 0) {
    funder <- org$get_default_funder
  }
  rightsholder <- org$get_default_rightsholder
  c(
    maintainer,
    c(
      vapply(
        rightsholder[rightsholder %in% funder],
        FUN = function(x) {
          list(org$get_person(x, role = c("cph", "fnd"), lang = lang))
        },
        FUN.VALUE = vector("list", 1)
      ),
      vapply(
        rightsholder[!rightsholder %in% funder],
        FUN = function(x) {
          list(org$get_person(x, role = "cph", lang = lang))
        },
        FUN.VALUE = vector("list", 1)
      ),
      vapply(
        funder[!funder %in% rightsholder],
        FUN = function(x) {
          list(org$get_person(x, role = "fnd", lang = lang))
        },
        FUN.VALUE = vector("list", 1)
      )
    ) |>
      do.call(what = c)
  )
}

#' @importFrom assertthat on_failure<-
on_failure(valid_package_name) <- function(call, env) {
  paste(deparse(call$x), "is not a valid package name.")
}

#' @importFrom fs file_copy path
#' @importFrom gert git_add
insert_file <- function(repo, filename, template, target, new_name) {
  if (missing(new_name)) {
    new_name <- path(target, filename)
  } else {
    new_name <- path(target, new_name)
  }
  path(template, filename) |>
    system.file(package = "checklist") |>
    file_copy(new_name, overwrite = TRUE)
  if (is.null(repo)) {
    return(invisible(NULL))
  }
  git_add(new_name, force = TRUE, repo = repo)
  return(invisible(NULL))
}

append_communities <- function(desc, org) {
  org$get_default_rightsholder |>
    vapply(FUN.VALUE = vector(mode = "list", 1), FUN = function(x) {
      list(org$get_zenodo_by_email(x))
    }) |>
    unlist() |>
    unique() -> communities
  if (length(communities) == 0) {
    return(desc)
  }
  desc$set(
    "Config/checklist/communities",
    paste(communities, collapse = "; ")
  )
}

ask_keywords <- function() {
  while (TRUE) {
    readline(prompt = "Enter one or more keywords separated by `;` ") |>
      strsplit(";") |>
      unlist() |>
      gsub(pattern = "^\\s+", replacement = "") |>
      gsub(pattern = "\\s+$", replacement = "") -> keywords
    keywords <- keywords[keywords != ""]
    if (length(keywords) > 0) {
      break
    }
    warning("Please enter at least one keyword.")
  }
  return(keywords)
}

ask_license <- function(org, type = c("package", "project", "data")) {
  type <- match.arg(type)
  org$get_default_rightsholder |>
    org$get_allowed_licenses(type = type) -> allowed
  stopifnot("no licenses found for this organisation" = length(allowed) > 0)
  if (length(allowed) > 1) {
    allowed <- allowed[menu_first(
      choices = names(allowed),
      title = "Select the license you want to use:"
    )]
  }
  return(names(allowed))
}

ask_language <- function(org) {
  available <- org$get_languages
  c(available, "other") |>
    menu_first(title = "Which language?") -> selected
  if (selected <= length(available)) {
    return(validate_language(available[selected]))
  }
  language <- readline(prompt = "Please enter the language code: ")
  while (inherits(try(validate_language(language)), "try-error")) {
    language <- readline(prompt = "Please enter the language code: ")
  }
  return(language)
}
