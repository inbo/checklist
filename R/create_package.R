#' Create an R package according to INBO requirements
#'
#' Creates a package template in a new folder.
#' Use this function when you want to start a new package.
#' Please DO READ `vignette("getting_started")` before running this function.
#'
#' @template checklist_structure
#'
#' @param package Name of the new package.
#' @param path Where to create the package directory.
#' @export
#' @importFrom assertthat assert_that is.flag is.string noNA
#' @importFrom desc description
#' @importFrom fs dir_create dir_ls file_copy is_dir path
#' @importFrom gert git_add git_init
#' @importFrom tools toTitleCase
#' @importFrom utils installed.packages
#' @family setup
create_package <- function(package, path = ".") {
  assert_that(
    length(find.package("roxygen2", quiet = TRUE)) > 0,
    msg = paste(
      "Please install the `roxygen2` package.",
      "`install.packages(\"roxygen2\")`"
    )
  )
  # validate user input
  assert_that(is_dir(path), msg = sprintf("`%s` is not a directory", path))
  assert_that(is.string(package))
  assert_that(valid_package_name(package))
  path <- path(path, package)
  assert_that(
    !is_dir(path) || length(dir_ls(path, recurse = TRUE)) == 0,
    msg = sprintf("`%s` is not an empty directory", path)
  )

  # ask interactive information
  title <- readline(prompt = "Enter the title: ")
  description <- readline(prompt = "Enter the description: ")
  keywords <- ask_keywords()
  preferred_protocol() |>
    sprintf(package) -> git
  org <- org_list_from_url(git)
  license <- ask_license(org, type = "package")
  language <- ask_language(org, "Which is the main language of the package?")
  info <- package_maintainer(org = org, lang = language)
  authors <- info$authors
  org <- info$org

  # start creating package
  dir_create(path)
  repo <- git_init(path = path)
  git_remote_add(url = git, name = "origin", repo = repo)
  dir_create(path(path, "R"))

  # add checklist.yml
  x <- checklist$new(x = path, package = TRUE, language = language)
  x$set_ignore(c(".github", "LICENSE.md", "docs"))
  write_checklist(x)
  git_add("checklist.yml", repo = repo)

  # add organsation info
  org$write(x = path)
  git_add("organisation.yml", repo = repo)

  # create DESCRIPTION
  desc <- desc::description$new("!new")
  desc$set("Package", package)
  desc$set("Title", toTitleCase(title))
  desc$set_version("0.0.0")
  desc$set_authors(authors)
  desc$set("Description", description)
  desc$set("License", ifelse(license == "MIT", "MIT + file LICENSE", license))
  desc$set_urls(sprintf("%s/%s", ssh_http(git), package))
  desc$set("BugReports", sprintf("%s/%s/issues", ssh_http(git), package))
  desc <- append_communities(desc = desc, org = org)
  desc$set("Config/checklist/keywords", paste(keywords, collapse = "; "))
  desc$set("Encoding", "UTF-8")
  desc$set("Language", language)
  desc$set("Roxygen", "list(markdown = TRUE)")
  desc$set("RoxygenNote", installed.packages()["roxygen2", "Version"])
  desc$del("Maintainer")
  desc$write(path(path, "DESCRIPTION"))
  git_add("DESCRIPTION", repo = repo)

  # create NAMESPACE
  c("# Generated by roxygen2: do not edit by hand", "") |>
    writeLines(path(path, "NAMESPACE"))
  git_add("NAMESPACE", repo = repo)

  # create RStudio project
  insert_file(
    repo = repo,
    filename = "rproj.template",
    template = "package_template",
    new_name = paste0(package, ".Rproj")
  )

  # add .gitignore
  insert_file(
    repo = repo,
    filename = "gitignore",
    template = "generic_template",
    new_name = ".gitignore"
  )

  # add .Rbuildignore
  insert_file(
    repo = repo,
    filename = "rbuildignore",
    template = "package_template",
    new_name = ".Rbuildignore"
  )

  # add codecov.yml
  insert_file(
    repo = repo,
    filename = "codecov.yml",
    template = "package_template"
  )

  # add NEWS.md
  paste(
    "# %s 0.0.0",
    "",
    "* Added a `NEWS.md` file to track changes to the package.",
    "* Add [`checklist`](https://inbo.github.io/checklist/) infrastructure.",
    sep = "\n"
  ) |>
    sprintf(package) |>
    writeLines(path(path, "NEWS.md"))
  git_add("NEWS.md", repo = repo)

  # add README.Rmd
  create_readme(
    path = path,
    org = org,
    lang = language,
    authors = author2df(authors) |>
      author2badge(),
    title = paste(package, title, sep = ": "),
    description = description,
    keywords = keywords,
    license = license,
    type = "package"
  )
  git_add("README.Rmd", repo = repo)

  # add LICENSE.md
  set_license(x, license = license, org = org)
  git_add("LICENSE.md", repo = repo)

  # Add code of conduct
  dir_create(path(path, ".github"))
  insert_file(
    repo = repo,
    filename = "CODE_OF_CONDUCT.md",
    template = "generic_template",
    target = ".github"
  )

  # Add contributing guidelines
  insert_file(
    repo = repo,
    filename = "CONTRIBUTING.md",
    template = "generic_template",
    target = ".github"
  )

  # Add GitHub actions
  target <- path(".github", "workflows")
  dir_create(path(path, target))
  insert_file(
    repo = repo,
    filename = "check_on_branch.yml",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "check_on_main.yml",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "check_on_different_r_os.yml",
    template = "package_template",
    target = target
  )
  insert_file(
    repo = repo,
    filename = "release.yml",
    template = "package_template",
    target = target
  )

  # prepare pkgdown
  setup_pkgdown(x = x, org = org, lang = language)

  message("package created at `", path, "`")

  if (
    !interactive() ||
      !requireNamespace("rstudioapi", quietly = TRUE) ||
      !rstudioapi::isAvailable()
  ) {
    return(invisible(NULL))
  }
  rstudioapi::openProject(path, newSession = TRUE)
}

valid_package_name <- function(x) {
  grepl("^[a-zA-Z][a-zA-Z0-9.]+$", x) && !grepl("\\.$", x)
}

package_maintainer <- function(org, lang) {
  message("Please select the maintainer")
  maintainer <- author2person(role = c("aut", "cre"), lang = lang)
  while (isTRUE(ask_yes_no("Add another author?", default = FALSE))) {
    maintainer <- c(maintainer, author2person(role = "aut", lang = lang))
  }
  info <- ask_rightsholder_funder(org = org, type = "rightsholder")
  rightsholder <- info$selection
  info <- ask_rightsholder_funder(org = info$org, type = "funder")
  funder <- info$selection
  org <- info$org
  list(
    authors = c(
      maintainer,
      c(
        vapply(
          rightsholder[rightsholder %in% funder],
          FUN = function(x) {
            list(org$get_person(x, role = c("cph", "fnd"), lang = lang))
          },
          FUN.VALUE = vector("list", 1)
        ),
        vapply(
          rightsholder[!rightsholder %in% funder],
          FUN = function(x) {
            list(org$get_person(x, role = "cph", lang = lang))
          },
          FUN.VALUE = vector("list", 1)
        ),
        vapply(
          funder[!funder %in% rightsholder],
          FUN = function(x) {
            list(org$get_person(x, role = "fnd", lang = lang))
          },
          FUN.VALUE = vector("list", 1)
        )
      ) |>
        do.call(what = c)
    ),
    org = org
  )
}

#' @importFrom assertthat on_failure<-
on_failure(valid_package_name) <- function(call, env) {
  paste(deparse(call$x), "is not a valid package name.")
}

#' @importFrom fs file_copy path
#' @importFrom gert git_add
insert_file <- function(repo, filename, template, target = ".", new_name) {
  if (missing(new_name)) {
    new_name <- filename
  }
  if (target != ".") {
    new_name <- path(target, new_name)
  }
  path(template, filename) |>
    system.file(package = "checklist") |>
    file_copy(path(repo, new_name), overwrite = TRUE)
  if (is.null(repo)) {
    return(invisible(NULL))
  }
  git_add(new_name, force = TRUE, repo = repo)
  return(invisible(NULL))
}

append_communities <- function(desc, org) {
  org$get_default_rightsholder |>
    vapply(FUN.VALUE = vector(mode = "list", 1), FUN = function(x) {
      list(org$get_zenodo_by_email(x))
    }) |>
    unlist() |>
    unique() -> communities
  if (length(communities) == 0) {
    return(desc)
  }
  desc$set(
    "Config/checklist/communities",
    paste(communities, collapse = "; ")
  )
}

ask_keywords <- function() {
  repeat {
    readline(prompt = "Enter one or more keywords separated by `;` ") |>
      strsplit(";") |>
      unlist() |>
      gsub(pattern = "^\\s+", replacement = "") |>
      gsub(pattern = "\\s+$", replacement = "") -> keywords
    keywords <- keywords[keywords != ""]
    if (length(keywords) > 0) {
      break
    }
    warning(
      "Please enter at least one keyword.",
      immediate. = TRUE,
      call. = FALSE
    )
  }
  return(keywords)
}

ask_license <- function(org, type = c("package", "project", "data")) {
  type <- match.arg(type)
  org$get_default_rightsholder |>
    org$get_allowed_licenses(type = type) -> allowed
  stopifnot("no licenses found for this organisation" = length(allowed) > 0)
  if (length(allowed) > 1) {
    allowed <- allowed[menu_first(
      choices = names(allowed),
      title = "Select the license you want to use:"
    )]
  }
  return(names(allowed))
}

ask_language <- function(org, prompt = "Which language?") {
  available <- org$get_languages
  c(available, "other") |>
    menu_first(title = prompt) -> selected
  if (selected <= length(available)) {
    return(validate_language(available[selected]))
  }
  language <- readline(prompt = "Please enter the language code: ")
  while (
    inherits(
      try(validate_language(language), silent = !interactive()),
      "try-error"
    )
  ) {
    language <- readline(prompt = "Please enter the language code: ")
  }
  return(language)
}
